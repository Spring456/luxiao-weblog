## 性能瓶颈点--从URL输入到页面加载整过程分析

### 页面加载大致过程是怎样的？

<!-- 详细可参考：[从输入URL到页面加载的全过程](../FrontEnd/Advanced/urlgc.md) -->

简单一点就是：

1、把URL解析为IP地址，浏览器会向DNS服务器发起DNS查询，获取IP地址

2、客户端和服务端建立连接。发起HTTP请求

3、服务器响应请求，向客户端传递数据

4、客户端拿到数据，并进行解析和渲染。最后渲染出网页

在这个流程上，主要分为3个阶段：`客户端发起请求阶段、服务端数据处理请求阶段、客户端页面渲染阶段`

### 客户端请求阶段的瓶颈点

客户端发起请求阶段是指用户在浏览器输入URL经过本地缓存确认是否已经存在这个网站，如果没有，接着由DNS查询从域名服务器获取这个IP地址，然后通过TCP三次握手，和TLS协商向服务器发起HTTP请求简历连接的过程。

`本地缓存`---为什么说本地缓存会成为前端性能的瓶颈点之一呢？

本地缓存可以让静态资源加载更快，当客户端发起一个请求时，静态资源可以直接从客户端获取，不需要再向服务器请求。

`实现本地缓存`--主要是`强缓存和协商缓存`

`强缓存：`是指浏览器在加载资源时，根据请求头的expire和cache-control判断是否命中客户端缓存。如果命中，则直接从缓存中获取

`协商缓存：`浏览器会先发送给一个请求到服务器，通过last-modified和etag验证资源是否命中客户端缓存。如果命中，服务器会返货数据，依然是从缓存中读取资源。否则就直接从服务器中请求。

`DNS查询：`

DNS之所以会成为前端性能瓶颈点，是因为每进行一次DNS查询，都要经历从手机到移动信号塔，再到认证DNS服务器的过程。

节省时间的办法就是让DNS查询走缓存，浏览器提供了DNS预获取的接口，我们可以在打开浏览器或webview的同时进行配置。

`HTTP请求`

最大的瓶颈点来源于请求阻塞

请求阻塞就是浏览器为保证访问速度会默认对同一域下的资源保持一定的连接数，请求过多就会进行阻塞。

`浏览器同域名的连接数限制是多少呢？`

一般是6个，如果当前请求数多于6个，只能6个并发，其余的得等最先返回的请求后，才能做下一次请求。

所以针对这种情况，在项目之初，做一些域名规划很重要。我们可以先看看当前页面需要用到哪些域名，最关键的首屏中需要用到哪些域名，规划这些域名的发送顺序。

还可以做域名散列。通过不同的域名，增加请求并行连接数。也就是将静态服务器地址做成支持多个域名的形式，每次请求随即分配域名请求，这样有多个域名同时可用，就会增加并发数。

### 服务端数据处理阶段的瓶颈点

服务端数据处理阶段是指webserver接受到请求后，从数据存储层取到数据，再返回给前端的过程。服务端程序接收到HTTP请求后，会做一些请求参数处理以及权限校验。

在这个过程中的的瓶颈点，在于是否做了数据缓存处理，是否做了GZIP压缩，是否有重定向。

`数据缓存`

`1、借助service worker的数据接口缓存`

是浏览器的一个高级属性，本质上是一个请求代理层，它存在的目的就是拦截和处理网络数据请求

`2、借助本地存储的接口缓存`

是指在一些对数据时效性要求不高的页面，第一次请求到数据后，程序将数据存储到本地存储，下一次请求的时候，先去缓存里面取，如果数据没有的话，再向服务器发起请求。

`3、CDN`

基本思路是通过网络各处放置节点服务器构造一个智能虚拟网络，将用户的请求导向离用户最近的服务节点上。

`为什么数据缓存会成为性能瓶颈点呢？`

这是因为每请求一次数据接口，需要从客户端到后端服务器再到后端的数据存储层，一层一层返回数据，最后再给到客户端，耗时很长。

`重定向`

重定向是指网站资源迁移到其他位置后，用户访问站点时，程序自动将用户请求从一个页面转移到另外一个页面的过程。

服务端的302重定向、meta标签实现的重定向、前端JS通过window.location实现的重定向。

这些都会引发新的DNS查询，导致新的TCP三次握手和TLS协商以及产生新的HTTP请求，而这些都会导致请求过程中更多的时间，进而影响前端性能。


### 页面解析和渲染阶段的瓶颈点

`解析`---就是HTML解析器将页面内容转换为DOM树和CSSOM树的过程。

`DOM树：`文档对象模型，它描述了标签之间的层次和结构。HTML解析器获取开始标签和结束标签生成相应的节点和节点之间的父子关系结构

`CSSOM：`css对象模型，主要描述样式集的层次和结构。

css解析器遍历其中每个规则，将css规则解析浏览器可解析和处理的样式集合，最后结合浏览器里面的默认样式，汇总形成具有父子关系的cssom树

主线程会计算DOM节点的最终样式，生成布局树，布局树会记录参与页面布局的节点和样式。


`绘制：`

绘制就是把各个节点绘制到屏幕上的过程，绘制结果以层的方式保存。当文档中各个部分以不同的层绘制时，相互重叠时，就必须进行合成。

解析渲染阶段流程环节多，逻辑复杂，瓶颈点多，比如DOM树构建过程，CSSOM树生成阶段，重排和重绘过程等。


#### 构建DOM树的瓶颈点

有3点会影响构建

1、当HTML标签不满足web语义化时，浏览器就需要更多时间去解析DOM标签的含义。比如缺少结束标签，或者标签之间嵌套不标准，嵌套结构复杂等。

遇到这些情况时，浏览器会进行语法纠错，这就会导致页面总的解析和渲染阶段需要更长的时间，严重影响页面展示性能。

2、DOM节点的数量越多，构建DOM树的时间就会变长，进而延长解析时间，拖慢页面展示速度。

3、文档中包含`<script>`标签时的情况

因为无论是DOM或者CSSOM都可以被JS访问并修改，所以一旦在页面解析时遇到`<script>`标签，DOM的构造过程就会暂停，等待服务器请求脚本。等脚本解析完成之后，进而改变CSSOM等

有时候`<script>`会成为优化的拦路虎。外部脚本的加载时机一定要确定好能够延迟加载就选用延迟加载。使用defer和async，告诉浏览器在等待脚本下载期间不阻止解析过程。


#### 布局中的瓶颈点

浏览器会根据样式解析器给出的样式规则，来计算某个元素需要占据的空间大小和屏幕中的位置，借助结算结果来进行布局。

因为浏览器每次布局计算都要作用于整个dom，如果元素量大，计算出所有元素的位置和尺寸会花很长的时间，所以布局阶段很容易成为性能瓶颈点


以上是介绍了解析，构建中的瓶颈点。其实页面加载全过程很复杂，内容也很多，还有诸如偏硬件领域，像GPU绘图，操作系统GUI和LCD显示等瓶颈点，网络层和服务层，如拥塞预防，负载均衡和慢启动；还有一些页面解析和渲染的算法，如解析算法，标记化算法和树构建算法等等。






